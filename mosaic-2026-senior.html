<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WRO 2026 Senior - Mosaic Paper Randomizer</title>
  <style>
    :root{
      --font: system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;

      /* --- 物理寸法（印刷基準） --- */
      --cell: 34mm;
      --gap: 16mm;

      /* --- 全体サイズ（あなた指定） --- */
      --paper-w: 183mm;
      --paper-h: 134mm;
    }
    body{ margin:0; font-family:var(--font); background:#fafafa; color:#111; }
    .wrap{ max-width:980px; margin:0 auto; padding:16px; }
    header{
      background:#fff; border-bottom:1px solid #e5e5e5;
    }
    header .wrap{ display:flex; flex-wrap:wrap; gap:10px 14px; align-items:center; }
    h1{ margin:0; font-size:16px; }
    .btn{
      padding:10px 12px; border-radius:12px; border:1px solid #ccc;
      background:#fff; font-weight:800; cursor:pointer;
    }
    .btn:hover{ background:#f2f2f2; }
    input{
      padding:9px 10px; border-radius:12px; border:1px solid #ccc; background:#fff;
      font-weight:700;
    }
    .bar{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

    /* 印刷対象 */
    .paper{
      width: var(--paper-w);
      height: var(--paper-h);
      background:#fff;
      border:1px solid #000; /* 外形確認用（不要なら消してOK） */
      box-sizing:border-box;
      padding: 0; /* ぴったり */
      margin-top: 14px;
      position: relative;
    }
    .arrow{
      position:absolute; top:6mm; left:6mm;
      font-weight:900; font-size:12px;
      background:#fff; padding:2px 6px; border:1px solid #000; border-radius:8px;
    }
    .grid{
      position:absolute;
      /* 6×4 を紙の中央に置く */
      left: 50%; top: 50%;
      transform: translate(-50%,-50%);
      display:grid;
      grid-template-columns: repeat(6, var(--cell));
      grid-template-rows: repeat(4, var(--cell));
      column-gap: var(--gap);
      row-gap: var(--gap);
    }
    .cell{
      width: var(--cell);
      height: var(--cell);
      border:1px solid #000;
      box-sizing:border-box;
    }

    .note{
      margin-top:10px; font-size:12px; color:#333; line-height:1.55;
    }

    @media print{
      body{ background:#fff; }
      header, .note { display:none; }
      .wrap{ padding:0; }
      .paper{ margin:0; border:0; } /* 余白・枠なしで刷りたい場合 */
    }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>WRO 2026 Senior — Mosaic Paper Randomizer</h1>
    <div class="bar">
      <input id="seed" type="text" placeholder="Seed (例: R1)" />
      <button class="btn" id="gen">All Random</button>
      <button class="btn" id="cap">Save Capture (PNG)</button>
      <button class="btn" id="print">Print</button>
      <button class="btn" onclick="location.href='./index.html'">Back</button>
    </div>
  </div>
</header>

<div class="wrap">
  <div id="paper" class="paper" aria-label="print paper">
    <div class="arrow">↑ TOP</div>
    <div id="grid" class="grid"></div>
  </div>

  <div class="note">
    ・印刷は「拡大縮小なし（100%）」推奨。まず定規で 34mm を確認してください。<br>
    ・24マスは 4色×各6個で均等。Seedを入れると同じ配置を再現できます。<br>
    ・この紙をモザイクフレームの下に置いてランダム化する運用は公式ルールの想定です。:contentReference[oaicite:4]{index=4}
  </div>
</div>

<script>
  const COLORS :contentReference[oaicite:5]{index=5}x:"#ffd400" }, // yellow
    { key:"B", hex:"#2f6bff" }, // blue
    { key:"G", hex:"#21b35b" }, // green
    { key:"W", hex:"#ffffff" }, // white
  ];

  // --- seeded RNG ---
  function xfnv1a(str){
    let h = 2166136261 >>> 0;
    for (let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return () => {
      h += h<<13; h ^= h>>>7;
      h += h<<3;  h ^= h>>>17;
      h += h<<5;
      return h>>>0;
    };
  }
  function mulberry32(a){
    return function(){
      let t = a += 0x6D2B79F5;
      t = Math.imul(t ^ (t>>>15), t | 1);
      t ^= t + Math.imul(t ^ (t>>>7), t | 61);
      return ((t ^ (t>>>14))>>>0) / 4294967296;
    }
  }
  function makeRng(seedStr){
    if(!seedStr) return Math.random;
    const seed = xfnv1a(seedStr)();
    return mulberry32(seed);
  }
  function shuffle(arr, rng){
    for(let i=arr.length-1;i>0;i--){
      const j = Math.floor(rng()*(i+1));
      [arr[i],arr[j]] = [arr[j],arr[i]];
    }
    return arr;
  }

  function generate(seedStr){
    const total = 24;
    const each = 6;
    const bag = [];
    for(const c of COLORS){
      for(let i=0;i<each;i++) bag.push(c);
    }
    shuffle(bag, makeRng(seedStr));
    return bag;
  }

  function render(bag){
    const grid = document.getElementById("grid");
    grid.innerHTML = "";
    bag.forEach(c => {
      const div = document.createElement("div");
      div.className = "cell";
      div.style.background = c.hex;
      grid.appendChild(div);
    });
  }

  // Save Capture: SVG経由でPNG化（外部ライブラリ不要）
  async function savePng(){
    const paper = document.getElementById("paper");
    const wmm = 183, hmm = 134;

    // 96dpi換算: 1in=25.4mm → px = mm * 96 / 25.4
    const pxW = Math.round(wmm * 96 / 25.4);
    const pxH = Math.round(hmm * 96 / 25.4);

    // paperをSVG foreignObjectでラップ（ほぼのブラウザで動作）
    const html = new XMLSerializer().serializeToString(paper);
    const svg =
`<svg xmlns="http://www.w3.org/2000/svg" width="${pxW}" height="${pxH}">
  <foreignObject width="100%" height="100%">
    <div xmlns="http://www.w3.org/1999/xhtml">${html}</div>
  </foreignObject>
</svg>`;

    const blob = new Blob([svg], {type:"image/svg+xml;charset=utf-8"});
    const url = URL.createObjectURL(blob);

    const img = new Image();
    img.onload = () => {
      const cv = document.createElement("canvas");
      cv.width = pxW; cv.height = pxH;
      const ctx = cv.getContext("2d");
      ctx.fillStyle = "#fff";
      ctx.fillRect(0,0,pxW,pxH);
      ctx.drawImage(img,0,0);

      URL.revokeObjectURL(url);
      const a = document.createElement("a");
      const seed = (document.getElementById("seed").value.trim() || "random").replace(/[^\w\-]+/g,"_");
      a.download = `mosaic_2026_senior_${seed}_${wmm}x${hmm}mm.png`;
      a.href = cv.toDataURL("image/png");
      a.click();
    };
    img.onerror = () => {
      URL.revokeObjectURL(url);
      alert("キャプチャに失敗しました。別ブラウザ（Chrome/Edge）で試してください。");
    };
    img.src = url;
  }

  function doGen(){
    const seed = document.getElementById("seed").value.trim();
    render(generate(seed));
  }

  document.getElementById("gen").addEventListener("click", doGen);
  document.getElementById("cap").addEventListener("click", savePng);
  document.getElementById("print").addEventListener("click", () => window.print());

  doGen();
</script>
</body>
</html>
